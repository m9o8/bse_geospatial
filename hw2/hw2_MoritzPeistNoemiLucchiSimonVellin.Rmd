---
title: "Geospatial - Assignment 2"
author: 
- Moritz Peist
- Noemi Lucchi
- Simon Vellin
output:
  html_document:
    toc: true
  pdf_document:
    toc: true
---

<hr>

```{css, echo=FALSE}
h1.title {
  text-align: center;
}

h4.author, h4.date {
  text-align: center;
}

.author {
  text-align: center;
}

.date {
  text-align: center;
}
```

```{r setup, include=FALSE}
# Disable warning messages
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

<div style="text-align: center;">
  <img src="../Barcelona_School_of_Economics_logo.svg" alt="BSE logo">
</div>

<hr>

# Methodology & general code

In this notebook, we combine the R package world with data from various sources to produce different types of plots. Throughout, we implement the methodologies recently discussed in class, such as distance computation, spatial merging, and filtering. Contentwise, the code follows always the same structure. We first load the data, secondly manipulate it, then we create the chart and finally display it.

First we load the needed packages:

```{r}
# Main tidyverse (includes ggplot2)
library(tidyverse)

# Spatial packages
library(sf)
library(spData)
library(tidyverse)
library(units)
library(lwgeom)
```

<hr>

## Map of total population by country

## Data Loading 

In order to plot the distribution of the total population by country, we import data from [Natural Earth](https://www.naturalearthdata.com), specifically the countries dataset which contains both the geometries of the countries and the corresponding population. 

```{r}

sf.world <- st_read("data/ne_10m_admin_0_countries", crs = 4326)

```


## Plotting

```{r}

# Population in absolute terms
ggplot() +
  geom_sf(data = sf.world, aes(fill = POP_EST)) +
  scale_fill_gradient(name = "Population", low = "lightblue", high = "blue")


```


## Histogram of country population distribution by continent

## Data Loading

As for the previous plot, we only need the R package world. 

## Data Wrangling 

We start by grouping South America and North America into a single category, "America," for simplicity. Additionally, we remove "Seven seas (open ocean)" and "Antarctica" since these regions only contain NA values in the population column and hence are irrelevant for the analysis. Next, we define population ranges by labeling countries based on their population size. After categorizing the countries into these ranges, we calculate the number of countries in each population range, grouped by continent. This gives us a summary of the distribution of countries by population size within each continent.
Finally, we ensure that the population ranges are ordered increasingly ("0-10M", "10M-50M", "50M-100M", "100M-500M", "500M+").

```{r}

# Remove Seven seas and Antarctica because they are NA
world <- world %>%
  mutate(
    continent = case_when(
      continent %in% c("Seven seas (open ocean)", "Antarctica") ~ NA_character_,
      TRUE ~ continent
    )
  ) %>%
  filter(!is.na(continent))

# Create the population ranges
world <- world %>%
  mutate(pop_range = case_when(
    pop < 1e7 ~ "0-10M",
    pop < 5e7 ~ "10M-50M",
    pop < 1e8 ~ "50M-100M",
    pop < 5e8 ~ "100M-500M",
    TRUE ~ "500M+"
  ))

# Calculate the number of countries per range + country
population_distribution <- world %>%
  group_by(continent, pop_range) %>%
  summarise(country_count = n(), .groups = "drop")

# Order by ranges
population_distribution <- population_distribution %>%
  mutate(pop_range = factor(pop_range, levels = c("0-10M", "10M-50M", "50M-100M", "100M-500M", "500M+")))

```


## Plotting

```{r}

ggplot(population_distribution, aes(x = pop_range, y = country_count, fill = continent)) +
  geom_histogram(stat = "identity", position = "dodge") +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Country Population Distribution by Continent", x = "Population Range",
    y = "Number of Countries", fill = "Continent")

```


## Histogram of country-level average distances between locations and airports by continent.

## Data Loading

In addition to the R package world, we incorporate data from [Natural Earth](https://www.naturalearthdata.com), specifically the datasets for populated places (sf.pop) and airports (sf.airports).

```{r}

sf.airports <- st_read("data/ne_10m_airports", crs = 4326)
sf.pop <- st_read("data/ne_10m_populated_places_simple", crs = 4326)

```

## Data Wrangling

This code computes and plots the average distances between populated places and airports across different continents, using two approaches: first, by computing the minimum distance for each city and averaging these values per country, and second, by directly averaging all city-airport distances within a country to allow for range-based visualization. Cities from the sf.pop dataset are joined with country and continent metadata from the world dataset, while airports from sf.airports are joined with country metadata. Distances are calculated at two levels: in "distances" we compute the minimum distance from each city to the nearest airport and average these values per country, while in "distances_country" we directly average all city-airport distances within a country. Then we categorize "distances_country" into ranges (e.g., <50 km, <100 km) to ensure a better visualization. The first plot shows the distribution of city-level average distances by continent, while the second plot shows the number of countries in each distance range, grouped by continent.

```{r}

# 1. Prepare cities and airports with country metadata
cities_with_countries <- world %>%
  st_drop_geometry() %>%
  select(iso_a2, continent) %>%
  left_join(
    sf.pop %>% select(name, iso_a2, ne_id, geometry),
    by = "iso_a2"
  ) %>%
  st_as_sf() %>%
  drop_na()

airports_with_countries <- sf.airports %>%
  select(name, geometry) %>%
  st_join(world %>% select(iso_a2, continent))

# 2. Calculate closest airport distance per city, then average per country
distances <- cities_with_countries %>%
  # For each country group:
  group_by(continent, iso_a2, ne_id) %>%
  summarise(
    avg_closest_distance_km = {
      current_iso <- cur_group()$iso_a2 # Capture current country code
      country_airports <- airports_with_countries %>%
        filter(iso_a2 == current_iso) # Filter airports for this country
      if (nrow(country_airports) == 0) {
        NA_real_ # Return NA if no airports exist
      } else {
        # Compute closest airport distance for each city in the country
        closest_distances <- st_distance(
          geometry, # City geometries
          country_airports # Airports in the current country
        ) %>%
          apply(1, min) %>% # Find minimum distance per city (row)
          as.numeric() / 1000 # Convert meters to kilometers
        mean(closest_distances, na.rm = TRUE)}}) %>% ungroup() %>% 
  drop_na() # Removecountries with no airports

# 3. Calculate average distances at country level. With this approach, instead of 
# computing the closest airport distance per city and then averaging per country, 
# we compute all the distances within a country and then we average them. 
distances_country <- cities_with_countries %>%
  group_by(continent, iso_a2) %>%  # Removed ne_id to group at country level
  summarise(
    avg_closest_distance_km = {
      current_iso <- cur_group()$iso_a2
      country_airports <- airports_with_countries %>%
        filter(iso_a2 == current_iso)
      if (nrow(country_airports) == 0) {
        NA_real_
      } else {
        closest_distances <- st_distance(
          geometry,
          country_airports
        ) %>%
          apply(1, min) %>%
          as.numeric() / 1000
        mean(closest_distances, na.rm = TRUE)}},
    country_name = first(name)) %>%  ungroup() %>%  drop_na()

# 4. Create distance ranges â€“ The previous step ensures a reasonable number of ranges. 
# If we had used the distances computed earlier, the higher granularity would have resulted in an excessive number of ranges, leading to a poor visualization quality.
distances_ranges <- distances_country %>%
  mutate(distance_range = cut(avg_closest_distance_km,
      breaks = seq(0, max(avg_closest_distance_km, na.rm = TRUE) + 50, by = 50),
      labels = paste0("<", seq(50, max(avg_closest_distance_km, na.rm = TRUE) + 50, by = 50), "km"),
      include.lowest = TRUE))

```


## Plotting 


```{r}

# Plot 1 
ggplot(distances, aes(x = avg_closest_distance_km, fill = continent)) +
  geom_histogram(bins = 30, position = "dodge") +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Average Distance Between Locations and Airports by Continent",
    x = "Average Distance to nearest Airport (km)", y = "Number of Populated Places", fill = "Continent"
  ) +
  facet_wrap(~continent, scales = "free")

# Plot 2
ggplot(distances_ranges, aes(x = distance_range, fill = continent)) +
  geom_bar(position = "stack") +
  scale_fill_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Average Distance Between Locations and Airport by Ranges",
    x = "Average Distance in Ranges", y = "Number of Countries", fill = "Continent")

```
